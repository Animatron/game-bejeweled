<!DOCTYPE html>
<html>
	<head>
		<title>Bejeweled - Animatron HTML5 Player Demo</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<script src="../player/vendor/matrix.js" type="text/javascript"></script>
		<script src="../player/anm.player.js" type="text/javascript"></script>
        <script src="../player/anm.collisions.js" type="text/javascript"></script>
		<script src="../player/anm.builder.js" type="text/javascript"></script>
		<script src="../player/animatron_import.js" type="text/javascript"></script>

		<script type="text/javascript">
			var width = 6; var height = 8;
			var mode = "grow";
			var modeTime = 0;
			var numShapes = 5;
			var swapDuration = .5;
			var shrinkDuration = .5;
			var fallDuration = .5;
			var board = new Array(height);
			var icons = new Array(height);
		
			var swap1 = null;
			var swap2 = null;
			var autoSwap = false;
			var remove = [];
			var fallTo = new Array(width);
			var fallNum = new Array(width);
			
			function start() {
				var b = Builder._$, B = Builder, C = anm.C;
				
				// canvas1
        	    var scene1 = b();
				
				var addIcon = function(i, j) {
					icons[i][j] = b(shape[board[i][j]])
							.xscale([0, .5], [0, 1])
							.modify(jewelModifier)
							.data({'i': i, 'j': j, 'targetX': 16 + 32*j, 'targetY': 16 + 32*i})
							.on(C.X_MCLICK, function(evt) {
									if (this.$.contains(evt.pos)) {
										var data = this.$.data();
										swap(data.i, data.j); 
									}
								});
					scene1.add(icons[i][j]);
				}
				
				var swap = function(i, j) {
					console.log(mode);
					if (mode == "wait") {
						console.log("hit: "+i+", "+j);
						if (swap1 == null)
							swap1 = [i, j];
						else {
							if (Math.abs(swap1[0]-i+swap1[1]-j) == 1) {
								swap2 = [i, j];
								console.log("swapping: "+swap1+", "+swap2);
								mode = "swap";
								modeTime = -1;
							} else {
								swap1 = null;
								mode = "wait";
							}
						}
					}
				}
				
				var checkRemove = function() {
					var remove = [];
					var last = null;
					var combo = 0;
					
					// check rows
					var start = Math.max(Math.min(swap1[1], swap2[1])-2, 0);
					var end = Math.min(Math.max(swap1[1], swap2[1])+2, width-1);
					for (var row=Math.min(swap1[0], swap2[0]); row<=Math.max(swap1[0], swap2[0]); row++) {
						//console.log("row", row, board[row], Math.max(Math.min(swap1[1], swap2[1])-2, 0), end);
						for (var col=start; col<=end; col++) {
							//console.log(row, col, board[row][col], last, combo);
							if (board[row][col] == last) {
								combo++;
								//console.log("combo", combo);
							}
							if (board[row][col] != last || col == end) {
								if (combo >= 3)
									while (combo > 0) {
										remove.push([row, col-combo+1])
										combo--;
									}
								else {
									last = board[row][col];
									combo = 1;
								}
							}
						}
					}
					
					last = null;
					combo = 0;
					
					// check cols
					var start = Math.max(Math.min(swap1[0], swap2[0])-2, 0);
					var end = Math.min(Math.max(swap1[0], swap2[0])+2, height-1);
					for (var col=Math.min(swap1[1], swap2[1]); col<=Math.max(swap1[1], swap2[1]); col++) {
						for (var row=start; row<=end; row++) {
							if (board[row][col] == last) {
								combo++;
							}
							if (board[row][col] != last || row == end) {
								if (combo >= 3)
									while (combo > 0) {
										remove.push([row-combo+1, col])
										combo--;
									}
								else {
									last = board[row][col];
									combo = 1;
								}
							}
						}
					}
					
					return remove;
				}
				
				var gameLoop = function(t) {
					if (modeTime == -1)
						modeTime = t;
						
					if (mode == "swap") {
						var i1 = icons[swap1[0]][swap1[1]];
						var i2 = icons[swap2[0]][swap2[1]];
						i1.data({'i': i1.data().i, 'j': i1.data().j,
								'targetX': 16+32*swap1[1] + 32*(swap2[1] - swap1[1])*(t - modeTime)/swapDuration,
								'targetY': 16+32*swap1[0] + 32*(swap2[0] - swap1[0])*(t - modeTime)/swapDuration});
						i2.data({'i': i2.data().i, 'j': i2.data().j,
								'targetX': 16+32*swap2[1] + 32*(swap1[1] - swap2[1])*(t - modeTime)/swapDuration,
								'targetY': 16+32*swap2[0] + 32*(swap1[0] - swap2[0])*(t - modeTime)/swapDuration});
						if (t - modeTime >= swapDuration) {
							// swap on board
							var temp = board[swap1[0]][swap1[1]];
							board[swap1[0]][swap1[1]] = board[swap2[0]][swap2[1]];
							board[swap2[0]][swap2[1]] = temp;
							temp = icons[swap1[0]][swap1[1]];
							icons[swap1[0]][swap1[1]] = icons[swap2[0]][swap2[1]];
							icons[swap2[0]][swap2[1]] = temp;
							icons[swap1[0]][swap1[1]].data({'i': swap2[0], 'j': swap2[1]});
							icons[swap2[0]][swap2[1]].data({'i': swap1[0], 'j': swap1[1]});
							remove = checkRemove();
							console.log("remove:", remove);
							if (remove.length == 0 && !autoSwap) {
								// swap back
								autoSwap = true;
								modeTime = t;
							} else {
								autoSwap = false;
								modeTime = t;
								mode = "shrink";
								swap1 = null;
							}
						}
					} else if (mode == "shrink") {
						for (var i=0; i<remove.length; i++)
							icons[remove[i][0]][remove[i][1]].data({'targetScale': 1 - (t - modeTime)/swapDuration});
						if (t - modeTime >= swapDuration) {
							mode = "fall";
							modeTime = t;
							for (var i=0; i<width; i++) {
								fallTo[i] = 0;
								fallNum[i] = 0;
							}
							for (var i=0; i<remove.length; i++) {
								a = remove[i];
								if (a[0] > fallTo[a[1]])
									fallTo[a[1]] = a[0];
								fallNum[a[1]]++;
							}
							
							// remove icons
							for (var i=0; i<remove.length; i++)
								scene1.remove(icons[remove[i][0]][remove[i][1]]);
							
							// change board
							for (var j=0; j<width; j++) {
								for (var i=fallTo[j]; i>=fallNum[j]; i--) {
									board[i][j] = board[i-fallNum[j]][j];
									icons[i][j] = icons[i-fallNum[j]][j];
									
									// update reference
									icons[i][j].data({'i': i, 'j': j});
								}
								for (var i=0; i<fallNum[j]; i++) {
									board[i][j] = Math.floor(Math.random()*numShapes);
									addIcon(i, j);
								}
							}
						}
					} else if (mode == "fall") {
						//console.log(fallTo, fallNum);
						for (var j=0; j<width; j++) {
							for (var i=0; i<=fallTo[j]; i++) {
								icons[i][j].data({'i': icons[i][j].data().i, 'j': icons[i][j].data().j, 'targetX': 16 + 32*j,
												'targetY': 16+32*(i-fallNum[j]) + 32*fallNum[j]*(t - modeTime)/fallDuration});
							}
						}
						if (t - modeTime >= fallDuration) {
							// TODO: examine board?
							for (var i=0; i<height; i++)
								console.log(board[i]);
							mode = "wait";
						}
					}
				}
				
				var jewelModifier = function(t) {
					if (b(this.$).data().targetX)
						this.x = b(this.$).data().targetX;
					if (b(this.$).data().targetY)
						this.y = b(this.$).data().targetY;
					if (b(this.$).data().targetScale) {
						this.sx = b(this.$).data().targetScale;
						this.sy = b(this.$).data().targetScale;
					}
				}
			
           		// 24x24
          		var octagon = b().path([ [-4, -12], [-12, -4], [-12, 4], [-4, 12], [4, 12], [12, 4], [12, -4], [4, -12], [-4, -12] ]).fill('#aaa');
				var diamond = b().path([ [0, -12], [-12, 0], [0, 12], [12, 0], [0, -12] ]).fill('#cc0');
				var triangle = b().path([ [-12, 12], [0, -12], [12, 12], [-12, 12] ]).fill('#c0a');
				var square = b().rect([0, 0], [24, 24]).fill('#c00');
				var hexagon = b().path([ [0, -12], [-12, -6], [-12, 6], [0, 12], [12, 6], [12, -6], [0, -12] ]).fill('#fa0');
				
				var shape = [octagon, diamond, triangle, square, hexagon];
    			
				// init board
				for (var i=0; i<height; i++) {
					board[i] = new Array(width);
					icons[i] = new Array(width);
					for (var j=0; j<width; j++)
						board[i][j] = Math.floor(Math.random()*numShapes);
				}
				
				var area = b().rect([width*16, height*16], [width*32, height*32]).fill('#fff')
							.modify(gameLoop);
				scene1.add(area);
				// draw from board
				for (var i=0; i<height; i++)
					for (var j=0; j<width; j++)
						addIcon(i, j);
				
				setTimeout("mode = 'wait';", 500);
				
                createPlayer('canvas1', {'mode': C.M_DYNAMIC}).load(scene1).play();
    
            }
        </script>
      </head>

	<body onload="start();">
		<h1>Bejeweled - Animatron HTML5 Player Demo</h1>

		<!-- canvas1 -->
		<canvas id="canvas1"></canvas>

	</body>

</html>